<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagramas GPX - Sistema de Gestión de Carreras</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.7.0/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 40px;
            font-size: 18px;
        }
        .diagram-section {
            margin-bottom: 50px;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .diagram-title {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }
        .diagram-description {
            color: #555;
            margin-bottom: 20px;
            font-style: italic;
        }
        .mermaid {
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .nav-menu {
            background-color: #34495e;
            padding: 15px;
            margin: -30px -30px 30px -30px;
            border-radius: 10px 10px 0 0;
        }
        .nav-menu a {
            color: white;
            text-decoration: none;
            margin-right: 20px;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .nav-menu a:hover {
            background-color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-menu">
            <a href="#arquitectura-sistema-unificada">🏗️ Arquitectura del Sistema Unificada</a>
            <a href="#sistema-autenticacion-completo">🔐 Sistema de Autenticación Completo</a>
            <a href="#frontend-arquitectura-completa">🎨 Frontend Arquitectura Completa</a>
            <a href="#modelo-datos">📊 Modelo de Datos</a>
            <a href="#flujo-carrera">🏁 Flujo de Carrera</a>
            <a href="#sistema-permisos">🛡️ Sistema de Permisos</a>
            <a href="#flujo-clasificaciones">📈 Flujo de Clasificaciones</a>
            <a href="#flujo-oauth2">🌐 Flujo OAuth2 Detallado</a>
            <a href="#flujo-registro-unificado">📝 Flujo de Registro Unificado</a>
            <a href="#testing-security">🧪 Testing y Seguridad</a>
            <a href="#stage-results-management">🏆 Gestión de Resultados de Etapas</a>
        </div>

        <h1>🏁 Sistema GPX - Gestión de Carreras</h1>
        <p class="subtitle">Diagramas de Arquitectura y Funcionamiento</p>

        <div id="arquitectura-sistema-unificada" class="diagram-section">
            <h2 class="diagram-title">🏗️ 1. Arquitectura del Sistema Unificada</h2>
            <p class="diagram-description">
                Visión general de la arquitectura del sistema, incluyendo frontend, backend, seguridad y capas de datos.
            </p>
            <div class="mermaid">
graph TB
    subgraph "🎨 Frontend - Next.js 14 App Router"
        subgraph "📱 Páginas Principales"
            HOME[🏠 / "HomePage"]
            CLASIF[📊 /clasificaciones]
            PROFILE[👤 /perfil]
            ADMIN[👨‍💼 /admin]
            LOGIN[🔐 /login]
            REGISTER[📝 /register]
            EVENTOS[🏁 /eventos]
            VEHICULOS[🚗 /vehiculos]
        end
        
        subgraph "🧩 Arquitectura de Componentes"
            subgraph "⚛️ Atoms"
                BTN[Button]
                INPUT[Input]
                CARD[Card]
                BADGE[Badge]
                TABLE[Table]
                SELECT[Select]
                DIALOG[Dialog]
            end
            
            subgraph "🔷 Molecules"
                FORM[Forms]
                NAVBAR[Navbar]
                SIDEBAR[Sidebar]
                LOADING[LoadingStates]
                TOAST[Toast]
            end
            
            subgraph "🏗️ Organisms"
                DASHBOARD[AdminDashboard]
                EVENTS_MGMT[EventsManagement]
                USERS_MGMT[UsersManagement]
                CATEGORIES_MGMT[CategoriesManagement]
                STAGE_RESULTS_MGMT[StageResultsManagement]
                PROFILE_FORM[ProfileForm]
                CLASIF_TABLE[ClasificacionTable]
            end
        end
        
        subgraph "🔧 Frontend Services"
            AUTH_CONTEXT[🔑 AuthContext]
            AUTH_UTILS[🔧 auth.utils.ts]
            AUTH_FETCH[📡 authFetch.ts]
            OAUTH_HANDLER[🌐 useOAuth2Handler]
            STORAGE[💾 Storage Utils]
        end
        
        subgraph "🎨 Styling & UI"
            TAILWIND[🎨 Tailwind CSS]
            SHADCN[🎯 shadcn/ui]
        end
    end
    
    subgraph "🔐 Security & Authentication Layer"
        JWT[🔑 JWT Authentication]
        SPRING_SEC[🛡️ Spring Security]
        OAUTH2[🌐 Google OAuth2]
        AUTH_GUARD[🛡️ Authentication Guards]
        ADMIN_GUARD[👑 Admin Guards]
    end
    
    subgraph "🌐 Backend API - Spring Boot"
        subgraph "🔐 Endpoints de Autenticación"
            AUTH_LOGIN[POST /api/users/login]
            AUTH_REGISTER[POST /api/users/simple-register]
            AUTH_OAUTH_URL[GET /api/users/oauth2/login-url]
            AUTH_SUCCESS[GET /api/oauth2/success]
            AUTH_STATUS[GET /api/oauth2/profile-status]
        end
        
        subgraph "👥 Endpoints de Usuarios"
            USER_LIST[GET /api/users "Admin"]
            USER_GET[GET /api/users/:id "Owner/Admin"]
            USER_UPDATE[PUT /api/users/:id "Owner/Admin"]
            USER_ADMIN[PATCH /api/users/:id/admin "Admin"]
            USER_COMPLETE[POST /api/users/:id/complete-profile]
            USER_PICTURE[PUT /api/users/:id/profile-picture]
            USER_CHECK[GET /api/users/check-email]
        end
        
        subgraph "🚗 Endpoints de Vehículos"
            VEHICLE_LIST[GET /api/vehicles "Admin"]
            VEHICLE_USER[GET /api/vehicles/user/:userId]
            VEHICLE_CREATE[POST /api/vehicles]
            VEHICLE_UPDATE[PUT /api/vehicles/:id "Owner/Admin"]
            VEHICLE_DELETE[DELETE /api/vehicles/:id "Owner/Admin"]
        end
        
        subgraph "🏁 Endpoints de Eventos"
            EVENT_LIST[GET /api/events]
            EVENT_CREATE[POST /api/events "Admin"]
            EVENT_UPDATE[PUT /api/events/:id "Admin"]
            EVENT_DELETE[DELETE /api/events/:id "Admin"]
        end
        
        subgraph "📍 Endpoints de Etapas"
            STAGE_LIST[GET /api/stages]
            STAGE_CREATE[POST /api/stages "Admin"]
            STAGE_UPDATE[PUT /api/stages/:id "Admin"]
            STAGE_DELETE[DELETE /api/stages/:id "Admin"]
        end
        
        subgraph "🎯 Endpoints de Categorías"
            CATEGORY_LIST[GET /api/categories]
            CATEGORY_CREATE[POST /api/categories "Admin"]
            CATEGORY_UPDATE[PUT /api/categories/:id "Admin"]
            CATEGORY_DELETE[DELETE /api/categories/:id "Admin"]
        end
        
        subgraph "📊 Endpoints de Resultados"
            RESULT_LIST[GET /api/stageresults]
            RESULT_CREATE[POST /api/stageresults "Admin"]
            RESULT_UPDATE[PUT /api/stageresults/:id "Admin"]
            RESULT_DELETE[DELETE /api/stageresults/:id "Admin"]
        end
    end
    
    subgraph "🏗️ Backend Architecture"
        subgraph "🎮 Controller Layer"
            UC[UserController]
            VC[VehicleController]
            EC[EventController]
            SC[StageController]
            SRC[StageResultController]
            EVC[EventVehicleController]
            ECC[EventCategoryController]
            CC[CategoryController]
        end
        
        subgraph "⚙️ Service Layer"
            US[UserService]
            VS[VehicleService]
            ES[EventService]
            SS[StageService]
            SRS[StageResultService]
            EVS[EventVehicleService]
            ECS[EventCategoryService]
            CS[CategoryService]
        end
        
        subgraph "📦 DTOs & Models"
            CDTO[CreateStageResultDTO]
            UDTO[UpdateStageResultDTO]
            PDTO[ParticipantDTO]
            CLDTO[ClasificacionDTO]
            USER_MODEL[User Entity]
            VEHICLE_MODEL[Vehicle Entity]
            EVENT_MODEL[Event Entity]
        end
    end
    
    subgraph "🗄️ Data Layer"
        DB[(PostgreSQL Database)]
        REPOSITORIES[JPA Repositories]
    end
    
    subgraph "🌐 External Services"
        GOOGLE_OAUTH[Google OAuth2 API]
        FILE_STORAGE[File Storage System]
    end
    
    %% Flujo Frontend a Backend
    HOME --> AUTH_FETCH
    ADMIN --> AUTH_GUARD
    PROFILE --> AUTH_CONTEXT
    LOGIN --> AUTH_LOGIN
    REGISTER --> AUTH_REGISTER
    
    %% Autenticación
    AUTH_FETCH --> JWT
    AUTH_GUARD --> SPRING_SEC
    AUTH_CONTEXT --> OAUTH2
    
    %% API Calls
    AUTH_FETCH --> USER_LIST
    AUTH_FETCH --> VEHICLE_LIST
    AUTH_FETCH --> EVENT_LIST
    AUTH_FETCH --> STAGE_LIST
    AUTH_FETCH --> CATEGORY_LIST
    AUTH_FETCH --> RESULT_LIST
    
    %% Backend Flow
    USER_LIST --> UC
    VEHICLE_LIST --> VC
    EVENT_LIST --> EC
    STAGE_LIST --> SC
    CATEGORY_LIST --> CC
    RESULT_LIST --> SRC
    
    UC --> US
    VC --> VS
    EC --> ES
    SC --> SS
    CC --> CS
    SRC --> SRS
    
    US --> REPOSITORIES
    VS --> REPOSITORIES
    ES --> REPOSITORIES
    SS --> REPOSITORIES
    CS --> REPOSITORIES
    SRS --> REPOSITORIES
    
    REPOSITORIES --> DB
    
    %% External Services
    OAUTH2 --> GOOGLE_OAUTH
    USER_PICTURE --> FILE_STORAGE
    
    %% Estilos
    classDef frontend fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef backend fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef security fill:#fff8e1,stroke:#ff8f00,stroke-width:2px
    classDef data fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef external fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    
    class HOME,CLASIF,PROFILE,ADMIN,LOGIN,REGISTER,EVENTOS,VEHICULOS,BTN,INPUT,CARD,BADGE,TABLE,SELECT,DIALOG,FORM,NAVBAR,SIDEBAR,LOADING,TOAST,DASHBOARD,EVENTS_MGMT,USERS_MGMT,CATEGORIES_MGMT,STAGE_RESULTS_MGMT,PROFILE_FORM,CLASIF_TABLE,AUTH_CONTEXT,AUTH_UTILS,AUTH_FETCH,OAUTH_HANDLER,STORAGE,TAILWIND,SHADCN frontend
    
    class AUTH_LOGIN,AUTH_REGISTER,AUTH_OAUTH_URL,AUTH_SUCCESS,AUTH_STATUS,USER_LIST,USER_GET,USER_UPDATE,USER_ADMIN,USER_COMPLETE,USER_PICTURE,USER_CHECK,VEHICLE_LIST,VEHICLE_USER,VEHICLE_CREATE,VEHICLE_UPDATE,VEHICLE_DELETE,EVENT_LIST,EVENT_CREATE,EVENT_UPDATE,EVENT_DELETE,STAGE_LIST,STAGE_CREATE,STAGE_UPDATE,STAGE_DELETE,CATEGORY_LIST,CATEGORY_CREATE,CATEGORY_UPDATE,CATEGORY_DELETE,RESULT_LIST,RESULT_CREATE,RESULT_UPDATE,RESULT_DELETE,UC,VC,EC,SC,SRC,EVC,ECC,CC,US,VS,ES,SS,SRS,EVS,ECS,CS,CDTO,UDTO,PDTO,CLDTO,USER_MODEL,VEHICLE_MODEL,EVENT_MODEL backend
    
    class JWT,SPRING_SEC,OAUTH2,AUTH_GUARD,ADMIN_GUARD security
    
    class DB,REPOSITORIES data
    
    class GOOGLE_OAUTH,FILE_STORAGE external
            </div>
        </div>

        <div id="sistema-autenticacion-completo" class="diagram-section">
            <h2 class="diagram-title">🔐 2. Sistema de Autenticación Completo</h2>
            <p class="diagram-description">
                Flujo detallado del sistema de autenticación, incluyendo login local y OAuth2.
            </p>
            <div class="mermaid">
graph TB
    subgraph "🎨 Frontend - Sistema de Autenticación"
        subgraph "🌐 Opciones de Login"
            LOGIN_LOCAL[📝 Login Local]
            LOGIN_OAUTH[🌐 Login Google OAuth2]
            REGISTER[📝 Registro Simple]
        end
        
        subgraph "🔑 Procesamiento Frontend"
            VALIDATE_FORM[✔️ Validar formulario]
            SEND_CREDENTIALS[📤 Enviar credenciales]
            REDIRECT_GOOGLE[🔄 Redirigir a Google]
            EXTRACT_PARAMS[📋 Extraer parámetros URL]
            STORE_TOKEN[💾 Guardar en localStorage]
            EXTRACT_USER[👤 Extraer datos usuario]
        end
        
        subgraph "🛡️ Protección de Rutas"
            AUTH_GUARD[🛡️ Guard de autenticación]
            ADMIN_GUARD[👑 Guard de admin]
            REDIRECT_LOGIN[🔄 Redirigir a login]
            ACCESS_GRANTED[✅ Acceso concedido]
        end
        
        subgraph "📡 Interceptor HTTP"
            ATTACH_TOKEN[🔗 Adjuntar token]
            HANDLE_401[❌ Manejar 401]
            AUTO_LOGOUT[🚪 Logout automático]
        end
    end
    
    subgraph "🖥️ Backend - Procesamiento de Autenticación"
        subgraph "🔐 Endpoints de Auth"
            API_LOGIN[POST /api/users/login]
            API_OAUTH_URL[GET /api/users/oauth2/login-url]
            API_OAUTH_CALLBACK[OAuth2 Callback]
            API_REGISTER[POST /api/users/simple-register]
        end
        
        subgraph "🔑 Procesamiento Backend"
            VERIFY_CREDENTIALS[🔍 Verificar credenciales]
            GENERATE_JWT[🔑 Generar JWT]
            EXCHANGE_CODE[🔄 Intercambiar código OAuth]
            CREATE_USER[👤 Crear/buscar usuario]
            VALIDATE_JWT[✔️ Validar JWT]
            SET_SECURITY_CONTEXT[🛡️ Establecer SecurityContext]
            CHECK_PERMISSIONS[🔍 Verificar permisos]
        end
    end
    
    subgraph "🌐 Servicios Externos"
        GOOGLE_OAUTH[🌐 Google OAuth2]
        DATABASE[(🗄️ Base de Datos)]
    end
    
    %% Flujo Login Local
    LOGIN_LOCAL --> VALIDATE_FORM
    VALIDATE_FORM --> SEND_CREDENTIALS
    SEND_CREDENTIALS --> API_LOGIN
    API_LOGIN --> VERIFY_CREDENTIALS
    VERIFY_CREDENTIALS --> DATABASE
    DATABASE --> GENERATE_JWT
    GENERATE_JWT --> STORE_TOKEN
    
    %% Flujo OAuth2
    LOGIN_OAUTH --> REDIRECT_GOOGLE
    REDIRECT_GOOGLE --> API_OAUTH_URL
    API_OAUTH_URL --> GOOGLE_OAUTH
    GOOGLE_OAUTH --> API_OAUTH_CALLBACK
    API_OAUTH_CALLBACK --> EXCHANGE_CODE
    EXCHANGE_CODE --> GOOGLE_OAUTH
    GOOGLE_OAUTH --> CREATE_USER
    CREATE_USER --> DATABASE
    DATABASE --> GENERATE_JWT
    GENERATE_JWT --> EXTRACT_PARAMS
    EXTRACT_PARAMS --> STORE_TOKEN
    
    %% Flujo Registro
    REGISTER --> VALIDATE_FORM
    VALIDATE_FORM --> API_REGISTER
    API_REGISTER --> CREATE_USER
    
    %% Gestión de Sesión y Seguridad
    STORE_TOKEN --> EXTRACT_USER
    EXTRACT_USER --> AUTH_GUARD
    AUTH_GUARD --> ADMIN_GUARD
    ADMIN_GUARD --> ACCESS_GRANTED
    ACCESS_GRANTED --> ATTACH_TOKEN
    
    %% Interceptor y Validación
    ATTACH_TOKEN --> VALIDATE_JWT
    VALIDATE_JWT --> SET_SECURITY_CONTEXT
    SET_SECURITY_CONTEXT --> CHECK_PERMISSIONS
    CHECK_PERMISSIONS --> |✅ Autorizado| ACCESS_GRANTED
    CHECK_PERMISSIONS --> |❌ No autorizado| HANDLE_401
    HANDLE_401 --> AUTO_LOGOUT
    AUTO_LOGOUT --> REDIRECT_LOGIN
    
    %% Estilos
    classDef frontend fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef backend fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef external fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    
    class LOGIN_LOCAL,LOGIN_OAUTH,REGISTER,VALIDATE_FORM,SEND_CREDENTIALS,REDIRECT_GOOGLE,EXTRACT_PARAMS,STORE_TOKEN,EXTRACT_USER,AUTH_GUARD,ADMIN_GUARD,REDIRECT_LOGIN,ACCESS_GRANTED,ATTACH_TOKEN,HANDLE_401,AUTO_LOGOUT frontend
    
    class API_LOGIN,API_OAUTH_URL,API_OAUTH_CALLBACK,API_REGISTER,VERIFY_CREDENTIALS,GENERATE_JWT,EXCHANGE_CODE,CREATE_USER,VALIDATE_JWT,SET_SECURITY_CONTEXT,CHECK_PERMISSIONS backend
    
    class GOOGLE_OAUTH,DATABASE external
            </div>
        </div>

        <div id="frontend-arquitectura-completa" class="diagram-section">
            <h2 class="diagram-title">🎨 3. Frontend Arquitectura Completa</h2>
            <p class="diagram-description">
                Estructura detallada de la arquitectura del frontend, componentes y flujos.
            </p>
            <div class="mermaid">
graph TB
    subgraph "Frontend - Arquitectura y Flujos Completos"        subgraph "Pages App Router"
            HOME_PAGE[page.tsx "HomePage"]
            CLASIF_PAGE[clasificaciones/page.tsx]
            PROFILE_PAGE[perfil/page.tsx]
            ADMIN_PAGE[admin/page.tsx]
            LOGIN_PAGE[login/page.tsx]
            REGISTER_PAGE[register/page.tsx]
        end
        
        subgraph "Atoms shadcn/ui"
            BUTTON[Button]
            INPUT[Input]
            LABEL[Label]
            CARD[Card + CardHeader + CardContent]
            BADGE[Badge]
            SELECT[Select + SelectItem]
            DIALOG[Dialog + DialogContent]
            TABLE[Table + TableHeader + TableRow]
            CHECKBOX[Checkbox]
            SWITCH[Switch]
            POPOVER[Popover + PopoverContent]
            TOAST[Toast + Sonner]
        end
          subgraph "Molecules Reusables"
            NAVBAR[Navbar "Navegacion principal"]
            SIDEBAR[Sidebar "Navegacion admin"]
            LOADING_SPINNER[LoadingSpinner]
            ERROR_BOUNDARY[ErrorBoundary]
            SEARCH_BAR[SearchBar]
            PAGINATION[Pagination]
            FILTERS[Filters]
            MODAL_WRAPPER[ModalWrapper]
        end
        
        subgraph "Organisms Complejos"
            ADMIN_DASHBOARD[AdminDashboard]
            EVENTS_MGMT[EventsManagement]
            USERS_MGMT[UsersManagement]
            CATEGORIES_MGMT[CategoriesManagement]
            STAGE_RESULTS_MGMT[StageResultsManagement]
            PROFILE_FORM[ProfileForm]
            VEHICLE_FORM[VehicleForm]
            CLASIF_TABLE[ClasificacionTable]
            EVENT_FORM[EventForm]
            PENALTY_DIALOG[PenaltyDialog]
        end
          subgraph "Templates Layouts"
            ADMIN_LAYOUT[AdminLayout "Sidebar + Content"]
            PROFILE_LAYOUT[ProfileLayout "User sidebar"]
            PUBLIC_LAYOUT[PublicLayout "Simple navbar"]
            AUTH_LAYOUT[AuthLayout "Centered forms"]
        end
        
        subgraph "Hooks Personalizados"
            USE_AUTH[useAuth]
            USE_API[useApi]
            USE_LOCAL_STORAGE[useLocalStorage]
            USE_DEBOUNCE[useDebounce]
            USE_PAGINATION[usePagination]
            USE_FORM_STATE[useFormState]
        end
          subgraph "Services API"
            AUTH_SERVICE[AuthService]
            EVENT_SERVICE[EventService]
            USER_SERVICE[UserService]
            VEHICLE_SERVICE[VehicleService]
            CATEGORY_SERVICE[CategoryService]
            STAGE_RESULT_SERVICE[StageResultService]
        end
        
        subgraph "Flujo Panel de Administracion"
            START[Usuario accede a /admin]
            CHECK_AUTH[Verificar autenticacion]
            CHECK_ADMIN[Verificar rol admin]
            REDIRECT[Redirigir a /login]
            
            subgraph "Dashboard Stats"
                STATS_EVENTS[Total eventos]
                STATS_USERS[Total usuarios]
                STATS_RECENT[Actividad reciente]
                STATS_FINISHED[Eventos finalizados]
            end
              subgraph "Events Management"
                LIST_EVENTS[Listar eventos]
                CREATE_EVENT[Crear evento]
                EDIT_EVENT[Editar evento]
                DELETE_EVENT[Eliminar evento]
            end
            
            subgraph "Users Management"
                LIST_USERS[Listar usuarios]
                TOGGLE_ADMIN[Cambiar rol admin]
                VIEW_VEHICLES[Ver vehiculos usuario]
                ADMIN_PROTECTION[Proteccion auto-admin]
            end
            
            subgraph "Categories Management"
                LIST_CATEGORIES[Listar categorias]
                CREATE_CATEGORY[Crear categoria]
                EDIT_CATEGORY[Editar categoria]
                DELETE_CATEGORY[Eliminar categoria]
            end
            
            subgraph "Stage Results Management"
                SELECT_EVENT[Seleccionar evento]
                LIST_RESULTS[Listar resultados]
                CREATE_RESULT[Crear resultado]
                EDIT_RESULT[Editar resultado basico]
                MANAGE_PENALIES[Gestionar penalizaciones]
                FILTER_STAGE[Filtrar por etapa]
                FILTER_CATEGORY[Filtrar por categoria]
                COLUMN_TOGGLE[Alternar columnas]
            end
        end
    end
    
    %% Flujo de navegación principal
    HOME_PAGE --> PUBLIC_LAYOUT
    CLASIF_PAGE --> PUBLIC_LAYOUT
    LOGIN_PAGE --> AUTH_LAYOUT
    REGISTER_PAGE --> AUTH_LAYOUT
    PROFILE_PAGE --> PROFILE_LAYOUT
    ADMIN_PAGE --> ADMIN_LAYOUT
    
    %% Relaciones de layouts
    ADMIN_LAYOUT --> SIDEBAR
    ADMIN_LAYOUT --> ADMIN_DASHBOARD
    PROFILE_LAYOUT --> SIDEBAR
    PUBLIC_LAYOUT --> NAVBAR
    AUTH_LAYOUT --> CARD
    
    %% Flujo de administración
    START --> CHECK_AUTH    CHECK_AUTH --> |No autenticado| REDIRECT
    CHECK_AUTH --> |Autenticado| CHECK_ADMIN
    CHECK_ADMIN --> |No admin| REDIRECT
    CHECK_ADMIN --> |Admin| ADMIN_DASHBOARD
    
    %% Dashboard connections
    ADMIN_DASHBOARD --> STATS_EVENTS
    ADMIN_DASHBOARD --> STATS_USERS
    ADMIN_DASHBOARD --> STATS_RECENT
    ADMIN_DASHBOARD --> STATS_FINISHED
    ADMIN_DASHBOARD --> EVENTS_MGMT
    ADMIN_DASHBOARD --> USERS_MGMT
    ADMIN_DASHBOARD --> CATEGORIES_MGMT
    ADMIN_DASHBOARD --> STAGE_RESULTS_MGMT
    
    %% Management connections
    EVENTS_MGMT --> LIST_EVENTS
    EVENTS_MGMT --> CREATE_EVENT
    EVENTS_MGMT --> EDIT_EVENT
    EVENTS_MGMT --> DELETE_EVENT
    EVENTS_MGMT --> EVENT_FORM
    
    USERS_MGMT --> LIST_USERS
    USERS_MGMT --> TOGGLE_ADMIN
    USERS_MGMT --> VIEW_VEHICLES
    USERS_MGMT --> ADMIN_PROTECTION
    
    CATEGORIES_MGMT --> LIST_CATEGORIES
    CATEGORIES_MGMT --> CREATE_CATEGORY
    CATEGORIES_MGMT --> EDIT_CATEGORY
    CATEGORIES_MGMT --> DELETE_CATEGORY
    
    STAGE_RESULTS_MGMT --> SELECT_EVENT
    STAGE_RESULTS_MGMT --> LIST_RESULTS
    STAGE_RESULTS_MGMT --> CREATE_RESULT
    STAGE_RESULTS_MGMT --> EDIT_RESULT
    STAGE_RESULTS_MGMT --> MANAGE_PENALIES
    STAGE_RESULTS_MGMT --> PENALTY_DIALOG
    
    %% Component usage
    EVENT_FORM --> DIALOG
    EVENT_FORM --> INPUT
    EVENT_FORM --> BUTTON
    
    LIST_USERS --> TABLE
    LIST_USERS --> SWITCH
    LIST_USERS --> BADGE
    
    PENALTY_DIALOG --> DIALOG
    PENALTY_DIALOG --> INPUT
    PENALTY_DIALOG --> SELECT
    
    %% Service connections
    EVENTS_MGMT --> EVENT_SERVICE
    USERS_MGMT --> USER_SERVICE
    CATEGORIES_MGMT --> CATEGORY_SERVICE
    STAGE_RESULTS_MGMT --> STAGE_RESULT_SERVICE
    
    %% Hook usage
    ADMIN_DASHBOARD --> USE_AUTH
    EVENTS_MGMT --> USE_API
    USERS_MGMT --> USE_PAGINATION
    STAGE_RESULTS_MGMT --> USE_FORM_STATE
    
    %% Estilos
    classDef page fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    classDef atom fill:#e1f5fe,stroke:#03a9f4,stroke-width:2px
    classDef molecule fill:#fce4ec,stroke:#e91e63,stroke-width:2px
    classDef organism fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef template fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef hook fill:#fff8e1,stroke:#ffc107,stroke-width:2px
    classDef service fill:#e0f2f1,stroke:#009688,stroke-width:2px
    classDef admin fill:#ffebee,stroke:#f44336,stroke-width:2px
    
    class HOME_PAGE,CLASIF_PAGE,PROFILE_PAGE,ADMIN_PAGE,LOGIN_PAGE,REGISTER_PAGE page
    class BUTTON,INPUT,LABEL,CARD,BADGE,SELECT,DIALOG,TABLE,CHECKBOX,SWITCH,POPOVER,TOAST atom
    class NAVBAR,SIDEBAR,LOADING_SPINNER,ERROR_BOUNDARY,SEARCH_BAR,PAGINATION,FILTERS,MODAL_WRAPPER molecule
    class ADMIN_DASHBOARD,EVENTS_MGMT,USERS_MGMT,CATEGORIES_MGMT,STAGE_RESULTS_MGMT,PROFILE_FORM,VEHICLE_FORM,CLASIF_TABLE,EVENT_FORM,PENALTY_DIALOG organism
    class ADMIN_LAYOUT,PROFILE_LAYOUT,PUBLIC_LAYOUT,AUTH_LAYOUT template
    class USE_AUTH,USE_API,USE_LOCAL_STORAGE,USE_DEBOUNCE,USE_PAGINATION,USE_FORM_STATE hook
    class AUTH_SERVICE,EVENT_SERVICE,USER_SERVICE,VEHICLE_SERVICE,CATEGORY_SERVICE,STAGE_RESULT_SERVICE service
    class START,CHECK_AUTH,CHECK_ADMIN,REDIRECT,STATS_EVENTS,STATS_USERS,STATS_RECENT,STATS_FINISHED,LIST_EVENTS,CREATE_EVENT,EDIT_EVENT,DELETE_EVENT,LIST_USERS,TOGGLE_ADMIN,VIEW_VEHICLES,ADMIN_PROTECTION,LIST_CATEGORIES,CREATE_CATEGORY,EDIT_CATEGORY,DELETE_CATEGORY,SELECT_EVENT,LIST_RESULTS,CREATE_RESULT,EDIT_RESULT,MANAGE_PENALIES,FILTER_STAGE,FILTER_CATEGORY,COLUMN_TOGGLE admin
            </div>
        </div>

        <div id="modelo-datos" class="diagram-section">
            <h2 class="diagram-title">📊 4. Modelo de Datos</h2>
            <p class="diagram-description">
                Diagrama Entidad-Relación de la base de datos del sistema.
            </p>
            <div class="mermaid">
erDiagram
    USER {
        Long id PK
        String firstName
        String lastName
        String email
        String password
        boolean isAdmin
        String picture
        String teamName
        LocalDateTime createdAt
        LocalDateTime updatedAt
        String oauthProvider
        String oauthProviderId
    }
    
    VEHICLE {
        Long id PK
        String name
        String plates
        String soat
        Long userId FK
        Long categoryId FK
        LocalDateTime createdAt
        LocalDateTime updatedAt
    }
    
    EVENT {
        Long id PK
        String name
        LocalDateTime startDate
        LocalDateTime endDate
        String location
        String description
        Double entryPrice
        String status
        LocalDateTime createdAt
        LocalDateTime updatedAt
    }
    
    STAGE {
        Long id PK
        String name
        String description
        Long eventId FK
        Integer orderNumber
        boolean isNeutralized
        LocalDateTime createdAt
        LocalDateTime updatedAt
    }
    
    CATEGORY {
        Long id PK
        String name
        String description
        LocalDateTime createdAt
        LocalDateTime updatedAt
    }
    
    EVENT_VEHICLE {
        Long id PK
        Long eventId FK
        Long vehicleId FK
        LocalDateTime registrationDate
        String status
    }
    
    EVENT_CATEGORY {
        Long id PK
        Long eventId FK
        Long categoryId FK
    }
    
    STAGE_RESULT {
        Long id PK
        Long stageId FK
        Long vehicleId FK
        LocalDateTime timestamp
        double latitude
        double longitude
        Duration penaltyWaypoint
        Duration penaltySpeed
        Duration discountClaim
        Integer elapsedTimeSeconds
    }
    
    USER ||--o{ VEHICLE : "owns"
    VEHICLE }o--|| CATEGORY : "belongs_to"
    EVENT ||--o{ STAGE : "contains"
    EVENT ||--o{ EVENT_VEHICLE : "has_participants"
    EVENT ||--o{ EVENT_CATEGORY : "has_categories"
    VEHICLE ||--o{ EVENT_VEHICLE : "participates_in"
    CATEGORY ||--o{ EVENT_CATEGORY : "categorizes"
    STAGE ||--o{ STAGE_RESULT : "has_results"
    VEHICLE ||--o{ STAGE_RESULT : "achieves"
            </div>
        </div>

        <div id="flujo-carrera" class="diagram-section">
            <h2 class="diagram-title">🏁 5. Flujo de Carrera</h2>
            <p class="diagram-description">
                Proceso completo de una carrera, desde la creación hasta los resultados.
            </p>
            <div class="mermaid">
flowchart TD
    A[Admin crea Evento]--> B[Admin define Etapas]
    B --> C[Admin configura Categorías del Evento]
    C --> D[Usuarios registran Vehículos]
    D --> E[Vehículos se inscriben al Evento]
    E --> F[Comienza la Carrera]
    F --> G[Se registran Tiempos por Etapa]
    G --> H{¿Hay penalizaciones?}
    H -->|Sí| I[Admin aplica penalizaciones]
    H -->|No| J[Calcular clasificaciones]
    I --> J
    J --> K[Generar clasificación completa]
    K --> L{¿Más etapas?}
    L -->|Sí| G
    L -->|No| M[Evento finalizado]
    M --> N[Clasificación final disponible]
            </div>
        </div>

        <div id="sistema-permisos" class="diagram-section">
            <h2 class="diagram-title">🛡️ 6. Sistema de Permisos</h2>
            <p class="diagram-description">
                Definición de roles, permisos y control de acceso en el sistema.
            </p>
            <div class="mermaid">
graph LR
    subgraph "Endpoints Publicos"
        P1[GET /api/categories]
        P2[POST /api/users/login]
        P3[POST /api/users/simple-register]
        P4[GET /api/events]
        P5[GET /api/stages]
        P6[GET /api/stageresults]
        P7[GET /api/event-vehicles/participants]
        P8[GET /api/event-vehicles/byevent]
        P9[GET /api/users/check-email]
        P10[GET /api/users/oauth2/login-url]
        P11[OAuth2 endpoints]
    end
      subgraph "Solo Administradores"
        A1[GET /api/users]
        A2[PATCH /api/users/:id/admin]
        A3[Gestion completa vehiculos]
        A4[POST/PUT/DELETE /api/events]
        A5[POST/PUT/DELETE /api/stages]
        A6[POST/PUT/DELETE /api/stageresults]
        A7[PUT /api/stageresults/penalizacion/:id]
        A8[GET /api/stageresults/clasificacion]
        A9[POST /api/stageresults/update-elapsed-times]
        A10[POST/PUT/DELETE /api/categories]
        A11[GET /api/stageresults/by-event/:eventId]
        A12[Panel Admin Dashboard]
    end
      subgraph "Usuario Autenticado"
        U1[GET /api/users/:id "propio"]
        U2[PUT /api/users/:id "propio"]
        U3[GET /api/vehicles "propios"]
        U4[POST /api/vehicles]
        U5[PUT/DELETE /api/vehicles "propios"]
        U6[Gestion EventVehicle propios]
        U7[POST /api/users/:id/complete-profile]
        U8[GET /api/oauth2/profile-status]
        U9[PUT /api/users/:id/profile-picture]
    end
      subgraph "Mixtos Admin/Propietario"
        M1[StageResults especificos]
        M2[EventVehicles especificos]
        M3[Vehiculos por usuario especifico]
        M4[Clasificaciones publicas vs admin]
    end
    
    subgraph "OAuth2 & Auth"
        O1[GET /api/oauth2/success]
        O2[Frontend redirect handling]
        O3[JWT Token validation]
        O4[AuthUtils validation]
    end
    
    subgraph "Frontend Routes"
        F1[/ "HomePage"]
        F2[/clasificaciones]
        F3[/perfil]
        F4[/admin "Solo admins"]
        F5[/login]
        F6[/register]
    end
            </div>
        </div>

        <div id="flujo-clasificaciones" class="diagram-section">
            <h2 class="diagram-title">📈 7. Flujo de Clasificaciones</h2>
            <p class="diagram-description">
                Proceso de cálculo y visualización de clasificaciones.
            </p>
            <div class="mermaid">
sequenceDiagram
    participant A as Admin
    participant SRC as StageResultController
    participant SRS as StageResultService
    participant DB as Database
    
    Note over A,DB: Obtener clasificación por etapa
    A->>SRC: GET /api/stage-results/clasificacion/stage/{id}
    SRC->>SRS: getClasificacionPorStage(stageId)
    SRS->>DB: Consultar resultados de etapa
    DB-->>SRS: Lista de resultados
    SRS-->>SRC: ClasificacionCompletaDTO[]
    SRC-->>A: Clasificación de etapa
    
    Note over A,DB: Obtener clasificación general
    A->>SRC: GET /api/stage-results/clasificacion/event/{id}
    SRC->>SRS: getClasificacionGeneral(eventId)
    SRS->>DB: Consultar todos los resultados
    DB-->>SRS: Resultados completos
    SRS->>SRS: Calcular tiempos totales
    SRS-->>SRC: ClasificacionCompletaDTO[]
    SRC-->>A: Clasificación general
    
    Note over A,DB: Aplicar penalización
    A->>SRC: PUT /api/stage-results/{id}/penalty
    SRC->>SRS: aplicarPenalizacion(id, penalty)
    SRS->>DB: Actualizar resultado
    DB-->>SRS: Confirmación
    SRS-->>SRC: Resultado actualizado
    SRC-->>A: 200 OK
            </div>
        </div>

        <div id="flujo-oauth2" class="diagram-section">
            <h2 class="diagram-title">🌐 8. Flujo OAuth2 Detallado</h2>
            <p class="diagram-description">
                Flujo específico de autenticación utilizando Google OAuth2.
            </p>
            <div class="mermaid">
sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant B as Backend
    participant G as Google OAuth2
    participant DB as Base de Datos
    participant JWT as JWT Service
    
    Note over U,DB: Inicio del flujo OAuth2
    U->>F: Clic "Iniciar sesión con Google"
    F->>B: GET /api/users/oauth2/login-url
    B-->>F: {loginUrl: "/oauth2/authorization/google"}
    
    Note over U,DB: Redirección a Google
    F->>B: Redirige a /oauth2/authorization/google
    B->>G: Redirige con client_id y scopes
    G-->>U: Muestra pantalla de consentimiento
    
    Note over U,DB: Autorización del usuario
    U->>G: Concede permisos (email, profile)
    G->>B: Callback: /login/oauth2/code/google?code=AUTH_CODE
    
    Note over U,DB: Intercambio de código por token
    B->>G: POST /token (code, client_id, client_secret)
    G-->>B: Access token + User info
    
    Note over U,DB: Procesamiento del usuario
    B->>B: OAuth2Service.processOAuth2User()
    B->>DB: Buscar usuario por email
    
    alt Usuario existente
        DB-->>B: Usuario encontrado
        B->>B: Actualizar googleId si es necesario
        B->>DB: Guardar cambios
    else Usuario nuevo
        B->>B: Crear usuario desde info de Google
        B->>DB: Guardar nuevo usuario
        DB-->>B: Usuario creado
    end
    
    Note over U,DB: Generación de JWT y redirección
    B->>JWT: generateToken(userId, isAdmin)
    JWT-->>B: JWT token
    B->>F: Redirige a frontend con parámetros
    Note right of B: URL: /oauth2/redirect?token=JWT&userId=123&admin=false&provider=google
    
    Note over U,DB: Manejo en frontend
    F->>F: Extraer token de URL
    F->>F: Guardar token en localStorage
    F->>F: Establecer estado de autenticación
    F-->>U: Usuario autenticado y redirigido
    
    Note over U,DB: Uso del token en requests posteriores
    U->>F: Navegar a página protegida
    F->>B: Request con Authorization: Bearer JWT
    B->>B: JwtRequestFilter valida token
    B->>DB: Buscar usuario por ID del token
    DB-->>B: Usuario válido
    B-->>F: Respuesta autorizada
    F-->>U: Contenido mostrado
            </div>
        </div>

        <div id="flujo-registro-unificado" class="diagram-section">
            <h2 class="diagram-title">📝 9. Flujo de Registro Unificado</h2>
            <p class="diagram-description">
                Proceso de registro de nuevos usuarios, tanto local como con OAuth2.
            </p>
            <div class="mermaid">
sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant B as Backend
    participant G as Google
    participant DB as Base de Datos
    
    Note over U,DB: Registro Unificado - Ambos métodos usan el mismo flujo
    
    U->>F: Elige método de registro
    
    alt Registro con Email/Contraseña
        U->>F: Llenar: firstName, lastName, email, password
        F->>B: POST /api/users/simple-register
        B->>DB: Verificar email no existe
        alt Email ya existe
            DB-->>B: Email encontrado
            B-->>F: Error: "Email ya registrado"
            F-->>U: Mostrar error
        else Email disponible
            B->>B: Crear usuario con datos mínimos
            Note right of B: firstName, lastName, email, password, authProvider=LOCAL
            B->>DB: Guardar usuario básico
            DB-->>B: Usuario creado
            B->>B: Generar JWT token
            B-->>F: {token, userId, profileComplete=false, authProvider=LOCAL}
        end
    else Registro con Google OAuth2
        U->>F: Clic "Registrarse con Google"
        F->>B: Redirigir a Google OAuth
        B->>G: Solicitar autorización
        G-->>U: Pantalla de consentimiento
        U->>G: Autorizar
        G->>B: Callback con datos
        B->>DB: Verificar/crear usuario
        B->>B: Procesar datos de Google
        Note right of B: firstName, lastName, email, picture, authProvider=GOOGLE
        B->>DB: Guardar usuario básico
        B->>B: Generar JWT token
        B-->>F: Redirigir con token y profileComplete=false
    end
    
    Note over U,DB: Flujo común después del registro
    F->>F: Evaluar profileComplete
    
    alt Perfil completo (casos raros)
        F->>F: Redirigir a dashboard
        F-->>U: Acceso completo
    else Perfil incompleto (caso normal)
        F->>F: Redirigir a completar perfil
        F-->>U: Formulario de datos esenciales
        
        Note over U,DB: Completar perfil (mismo para ambos métodos)
        U->>F: Llenar: identification, phone, role
        F->>B: POST /api/users/{id}/complete-profile
        B->>DB: Actualizar usuario
        DB-->>B: Usuario completado
        B-->>F: Perfil completado
        F->>F: Redirigir a dashboard
        F-->>U: Acceso completo a la aplicación
    end
    
    Note over U,DB: Login posterior (ambos métodos)
    U->>F: Iniciar sesión
    
    alt Login tradicional
        F->>B: POST /api/users/login (email, password)
    else Login OAuth2
        F->>B: Flujo OAuth2 Google
    end
    
    B->>DB: Verificar usuario
    DB-->>B: Usuario encontrado
    B->>B: Verificar si perfil está completo
    B-->>F: {token, profileComplete, firstName, ...}
    
    alt Perfil completo
        F-->>U: Acceso directo al dashboard
    else Perfil incompleto
        F-->>U: Redirigir a completar perfil
    end
            </div>
        </div>

        <div id="testing-security" class="diagram-section">
            <h2 class="diagram-title">🧪 10. Testing y Seguridad</h2>
            <p class="diagram-description">
                Estrategias de testing y medidas de seguridad implementadas.
            </p>
            <div class="mermaid">
graph TB
    subgraph "Testing Architecture"
        subgraph "Test Configuration"
            TC1[MockitoExtension]
            TC2[@Mock SecurityContext]
            TC3[@Mock Authentication] 
            TC4[@Mock HttpServletRequest]
            TC5[ReflectionTestUtils]
        end
        
        subgraph "Security Testing Patterns"
            ST1[Admin User Mocking]
            ST2[Regular User Mocking]
            ST3[Static Method Handling]
            ST4[Authentication Principal Setup]
        end
          subgraph "Test Categories"
            TT1[Authentication Tests]
            TT2[Authorization Tests]
            TT3[Business Logic Tests]
            TT4[Error Handling Tests]
        end
    end
      subgraph "Mock Setup Process"
        MS1[when authentication.getPrincipal]
        MS2[thenReturn userWithAdminStatus]
        MS3[SecurityContextHolder setup]
        MS4[HttpServletRequest injection]
    end
      subgraph "Test Scenarios"
        TS1[Admin creates/updates/deletes]
        TS2[Regular user access own resources]
        TS3[Regular user blocked from admin actions]
        TS4[OAuth2 user profile completion]
        TS5[JWT token validation]
    end
    
    subgraph "Updated Test Files"
        TF1[UserControllerTests ✅]
        TF2[StageResultControllerTests ✅]
        TF3[EventVehicleControllerTests ✅]
        TF4[EventCategoryControllerTests ✅]
        TF5[OAuth2ControllerTests ✅]
        TF6[VehicleControllerTests ✅]
    end
    
    subgraph "Fixed Issues"
        FI1[Removed duplicate getGoogleLoginUrl test]
        FI2[Fixed pom.xml versions compatibility]
        FI3[Added missing @GetMapping annotations]
        FI4[Consistent service method calls]
    end
    
    TC1 --> ST1
    TC2 --> MS1
    TC3 --> MS2
    TC4 --> MS4
    TC5 --> MS4
    
    ST1 --> TS1
    ST2 --> TS2
    ST3 --> TS3
    ST4 --> TS4
    
    MS1 --> TT2
    MS2 --> TT1
    MS3 --> TT3
    MS4 --> TT4
    
    TT1 --> TF1
    TT2 --> TF2
    TT3 --> TF3
    TT4 --> TF4
    
    FI1 --> TF5
    FI2 --> TF6
    FI3 --> TF4
    FI4 --> TF2
    
    style TF1 fill:#90EE90
    style TF2 fill:#90EE90
    style TF3 fill:#90EE90
    style TF4 fill:#90EE90
    style TF5 fill:#90EE90
    style TF6 fill:#90EE90
            </div>
        </div>

        <div id="stage-results-management" class="diagram-section">
            <h2 class="diagram-title">🏆 11. Gestión de Resultados de Etapas</h2>
            <p class="diagram-description">
                Flujo detallado para la administración de resultados de las etapas de un evento.
            </p>
            <div class="mermaid">
graph TD
    subgraph "Stage Results Management - Flujo Detallado"        START[Acceso a gestion de resultados]
        
        subgraph "Seleccion de Evento"
            SELECT_EVENT[Seleccionar evento activo]
            LOAD_STAGES[Cargar etapas del evento]
            LOAD_VEHICLES[Cargar vehiculos participantes]
            LOAD_CATEGORIES[Cargar categorias]
        end
          subgraph "Sistema de Filtros"
            FILTER_STAGE[Filtro por etapa]
            FILTER_CATEGORY[Filtro por categoria]
            APPLY_FILTERS[Aplicar filtros combinados]
            RESET_FILTERS[Resetear filtros]
        end
        
        subgraph "Selector de Columnas"
            COLUMN_TOGGLE[Toggle columnas visibles]
            COLUMN_CONFIG[Configuracion columnas]
            SAVE_PREFS[Guardar preferencias]
            DEFAULT_COLS[Columnas por defecto]
        end
        
        subgraph "Tabla de Resultados"
            DISPLAY_TABLE[Mostrar tabla filtrada]
            PARTICIPANT_INFO[Info participante + avatar]
            VEHICLE_INFO[Info vehiculo]
            CATEGORY_PLAIN[Categoria texto plano]
            STAGE_PLAIN[Etapa texto plano]
            TIMESTAMP_INFO[Timestamp resultado]
            PENALTIES_INFO[Info penalizaciones]
        end
        
        subgraph "Crear Resultado"
            NEW_RESULT_BTN[Boton nuevo resultado]
            NEW_RESULT_FORM[Formulario nuevo resultado]
            SELECT_STAGE_NEW[Seleccionar etapa]
            SELECT_VEHICLE_NEW[Seleccionar vehiculo]
            INPUT_TIMESTAMP[Ingresar timestamp]
            INPUT_COORDS[Ingresar coordenadas]
            VALIDATE_NEW[Validar datos nuevos]
            SAVE_NEW_RESULT[Guardar resultado]
        end
        
        subgraph "Editar Resultado"
            EDIT_RESULT_BTN[Boton editar]
            EDIT_RESULT_FORM[Formulario edicion]
            UPDATE_TIMESTAMP[Actualizar timestamp]
            UPDATE_COORDS[Actualizar coordenadas]            VALIDATE_EDIT[Validar cambios]
            SAVE_EDIT_RESULT[Guardar cambios]
        end
        
        subgraph "Gestion de Penalizaciones"
            PENALTY_BTN[Boton penalizaciones]
            PENALTY_DIALOG[Dialogo penalizaciones]
            PENALTY_WAYPOINT[Penalizacion waypoint]
            PENALTY_SPEED[Penalizacion velocidad]
            DISCOUNT_CLAIM[Reclamo descuento]
            CALCULATE_PENALTY[Calcular penalizacion total]
            SAVE_PENALTIES[Guardar penalizaciones]
        end
        
        subgraph "Eliminar Resultado"
            DELETE_BTN[Boton eliminar]
            CONFIRM_DELETE[Confirmar eliminacion]
            DELETE_RESULT[Eliminar resultado]
        end
        
        subgraph "Responsive Design"
            MOBILE_VIEW[Vista movil]
            TABLET_VIEW[Vista tablet]
            DESKTOP_VIEW[Vista escritorio]
            OVERFLOW_SCROLL[Scroll horizontal]
            MIN_WIDTH[Ancho minimo tabla]
        end
        
        subgraph "Estado y Sincronizacion"
            LOADING_STATE[Estado cargando]
            ERROR_STATE[Manejo errores]
            SUCCESS_TOAST[Notificacion exito]
            ERROR_TOAST[Notificacion error]
            REFRESH_DATA[Refrescar datos]
        end
    end
    
    %% Flujo principal
    START --> SELECT_EVENT
    SELECT_EVENT --> LOAD_STAGES
    LOAD_STAGES --> LOAD_VEHICLES
    LOAD_VEHICLES --> LOAD_CATEGORIES
    LOAD_CATEGORIES --> DISPLAY_TABLE
    
    %% Sistema de filtros
    DISPLAY_TABLE --> FILTER_STAGE
    DISPLAY_TABLE --> FILTER_CATEGORY
    FILTER_STAGE --> APPLY_FILTERS
    FILTER_CATEGORY --> APPLY_FILTERS
    APPLY_FILTERS --> DISPLAY_TABLE
    RESET_FILTERS --> DISPLAY_TABLE
    
    %% Selector de columnas
    DISPLAY_TABLE --> COLUMN_TOGGLE
    COLUMN_TOGGLE --> COLUMN_CONFIG
    COLUMN_CONFIG --> SAVE_PREFS
    SAVE_PREFS --> DISPLAY_TABLE
    
    %% Crear resultado
    DISPLAY_TABLE --> NEW_RESULT_BTN
    NEW_RESULT_BTN --> NEW_RESULT_FORM
    NEW_RESULT_FORM --> SELECT_STAGE_NEW
    NEW_RESULT_FORM --> SELECT_VEHICLE_NEW
    NEW_RESULT_FORM --> INPUT_TIMESTAMP
    NEW_RESULT_FORM --> INPUT_COORDS
    INPUT_COORDS --> VALIDATE_NEW
    VALIDATE_NEW --> SAVE_NEW_RESULT
    SAVE_NEW_RESULT --> SUCCESS_TOAST
    SAVE_NEW_RESULT --> REFRESH_DATA
    
    %% Editar resultado
    DISPLAY_TABLE --> EDIT_RESULT_BTN
    EDIT_RESULT_BTN --> EDIT_RESULT_FORM
    EDIT_RESULT_FORM --> UPDATE_TIMESTAMP
    EDIT_RESULT_FORM --> UPDATE_COORDS
    UPDATE_COORDS --> VALIDATE_EDIT
    VALIDATE_EDIT --> SAVE_EDIT_RESULT
    SAVE_EDIT_RESULT --> SUCCESS_TOAST
    SAVE_EDIT_RESULT --> REFRESH_DATA
    
    %% Gestión de penalizaciones
    DISPLAY_TABLE --> PENALTY_BTN
    PENALTY_BTN --> PENALTY_DIALOG
    PENALTY_DIALOG --> PENALTY_WAYPOINT
    PENALTY_DIALOG --> PENALTY_SPEED
    PENALTY_DIALOG --> DISCOUNT_CLAIM
    DISCOUNT_CLAIM --> CALCULATE_PENALTY
    CALCULATE_PENALTY --> SAVE_PENALTIES
    SAVE_PENALTIES --> SUCCESS_TOAST
    SAVE_PENALTIES --> REFRESH_DATA
    
    %% Eliminar resultado
    DISPLAY_TABLE --> DELETE_BTN
    DELETE_BTN --> CONFIRM_DELETE
    CONFIRM_DELETE --> DELETE_RESULT
    DELETE_RESULT --> SUCCESS_TOAST
    DELETE_RESULT --> REFRESH_DATA
    
    %% Manejo de errores
    VALIDATE_NEW -.->|Error| ERROR_TOAST
    VALIDATE_EDIT -.->|Error| ERROR_TOAST
    SAVE_NEW_RESULT -.->|Error| ERROR_TOAST
    SAVE_EDIT_RESULT -.->|Error| ERROR_TOAST
    SAVE_PENALTIES -.->|Error| ERROR_TOAST
    DELETE_RESULT -.->|Error| ERROR_TOAST
    
    %% Estados
    LOADING_STATE --> DISPLAY_TABLE
    ERROR_STATE --> DISPLAY_TABLE
    REFRESH_DATA --> LOADING_STATE

    classDef primary fill:#3b82f6,stroke:#1e40af,color:white
    classDef success fill:#10b981,stroke:#059669,color:white
    classDef warning fill:#f59e0b,stroke:#d97706,color:white
    classDef danger fill:#ef4444,stroke:#dc2626,color:white
    classDef info fill:#6366f1,stroke:#4f46e5,color:white

    class START,SELECT_EVENT,DISPLAY_TABLE primary
    class SUCCESS_TOAST,SAVE_NEW_RESULT,SAVE_EDIT_RESULT,SAVE_PENALTIES success
    class VALIDATE_NEW,VALIDATE_EDIT,CONFIRM_DELETE warning
    class DELETE_RESULT,ERROR_TOAST,ERROR_STATE danger
    class COLUMN_TOGGLE,FILTER_STAGE,FILTER_CATEGORY info
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#3498db',
                primaryTextColor: '#2c3e50',
                primaryBorderColor: '#2980b9',
                lineColor: '#34495e',
                secondaryColor: '#ecf0f1',
                tertiaryColor: '#f8f9fa'
            }
        });
    </script>
</body>
</html>