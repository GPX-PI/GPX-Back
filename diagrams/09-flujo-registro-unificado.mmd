sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant B as Backend
    participant G as Google
    participant DB as Base de Datos
    
    Note over U,DB: Registro Unificado - Ambos métodos usan el mismo flujo
    
    U->>F: Elige método de registro
    
    alt Registro con Email/Contraseña
        U->>F: Llenar: firstName, lastName, email, password
        F->>B: POST /api/users/simple-register
        B->>DB: Verificar email no existe
        alt Email ya existe
            DB-->>B: Email encontrado
            B-->>F: Error: "Email ya registrado"
            F-->>U: Mostrar error
        else Email disponible
            B->>B: Crear usuario con datos mínimos
            Note right of B: firstName, lastName, email, password, authProvider=LOCAL
            B->>DB: Guardar usuario básico
            DB-->>B: Usuario creado
            B->>B: Generar JWT token
            B-->>F: {token, userId, profileComplete=false, authProvider=LOCAL}
        end
    else Registro con Google OAuth2
        U->>F: Clic "Registrarse con Google"
        F->>B: Redirigir a Google OAuth
        B->>G: Solicitar autorización
        G-->>U: Pantalla de consentimiento
        U->>G: Autorizar
        G->>B: Callback con datos
        B->>DB: Verificar/crear usuario
        B->>B: Procesar datos de Google
        Note right of B: firstName, lastName, email, picture, authProvider=GOOGLE
        B->>DB: Guardar usuario básico
        B->>B: Generar JWT token
        B->>F: Redirigir con token y profileComplete=false
    end
    
    Note over U,DB: Flujo común después del registro
    F->>F: Evaluar profileComplete
    
    alt Perfil completo (casos raros)
        F->>F: Redirigir a dashboard
        F-->>U: Acceso completo
    else Perfil incompleto (caso normal)
        F->>F: Redirigir a completar perfil
        F-->>U: Formulario de datos esenciales
        
        Note over U,DB: Completar perfil (mismo para ambos métodos)
        U->>F: Llenar: identification, phone, role
        F->>B: POST /api/users/{id}/complete-profile
        B->>DB: Actualizar usuario
        DB-->>B: Usuario completado
        B-->>F: Perfil completado
        F->>F: Redirigir a dashboard
        F-->>U: Acceso completo a la aplicación
    end
    
    Note over U,DB: Login posterior (ambos métodos)
    U->>F: Iniciar sesión
    
    alt Login tradicional
        F->>B: POST /api/users/login (email, password)
    else Login OAuth2
        F->>B: Flujo OAuth2 Google
    end
    
    B->>DB: Verificar usuario
    DB-->>B: Usuario encontrado
    B->>B: Verificar si perfil está completo
    B-->>F: {token, profileComplete, firstName, ...}
    
    alt Perfil completo
        F-->>U: Acceso directo al dashboard
    else Perfil incompleto
        F-->>U: Redirigir a completar perfil
    end 