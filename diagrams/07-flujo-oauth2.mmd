sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant B as Backend
    participant G as Google OAuth2
    participant DB as Base de Datos
    participant JWT as JWT Service
    
    Note over U,DB: Inicio del flujo OAuth2
    U->>F: Clic "Iniciar sesión con Google"
    F->>B: GET /api/users/oauth2/login-url
    B-->>F: {loginUrl: "/oauth2/authorization/google"}
    
    Note over U,DB: Redirección a Google
    F->>B: Redirige a /oauth2/authorization/google
    B->>G: Redirige con client_id y scopes
    G-->>U: Muestra pantalla de consentimiento
    
    Note over U,DB: Autorización del usuario
    U->>G: Concede permisos (email, profile)
    G->>B: Callback: /login/oauth2/code/google?code=AUTH_CODE
    
    Note over U,DB: Intercambio de código por token
    B->>G: POST /token (code, client_id, client_secret)
    G-->>B: Access token + User info
    
    Note over U,DB: Procesamiento del usuario
    B->>B: OAuth2Service.processOAuth2User()
    B->>DB: Buscar usuario por email
    
    alt Usuario existente
        DB-->>B: Usuario encontrado
        B->>B: Actualizar googleId si es necesario
        B->>DB: Guardar cambios
    else Usuario nuevo
        B->>B: Crear usuario desde info de Google
        B->>DB: Guardar nuevo usuario
        DB-->>B: Usuario creado
    end
    
    Note over U,DB: Generación de JWT y redirección
    B->>JWT: generateToken(userId, isAdmin)
    JWT-->>B: JWT token
    B->>F: Redirige a frontend con parámetros
    Note right of B: URL: /oauth2/redirect?token=JWT&userId=123&admin=false&provider=google
    
    Note over U,DB: Manejo en frontend
    F->>F: Extraer token de URL
    F->>F: Guardar token en localStorage
    F->>F: Establecer estado de autenticación
    F-->>U: Usuario autenticado y redirigido
    
    Note over U,DB: Uso del token en requests posteriores
    U->>F: Navegar a página protegida
    F->>B: Request con Authorization: Bearer JWT
    B->>B: JwtRequestFilter valida token
    B->>DB: Buscar usuario por ID del token
    DB-->>B: Usuario válido
    B-->>F: Respuesta autorizada
    F-->>U: Contenido mostrado 