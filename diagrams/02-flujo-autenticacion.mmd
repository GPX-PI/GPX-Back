sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant B as Backend
    participant JWT as JwtUtil
    participant SC as SecurityContext
    participant G as Google OAuth
    participant DB as Base de Datos
    
    Note over U,DB: Login tradicional (email/password)
    U->>F: Login (email, password)
    F->>B: POST /api/users/login
    B->>DB: Verificar credenciales
    DB-->>B: Usuario válido
    B->>JWT: Generar token
    JWT-->>B: Token JWT
    B-->>F: Token + info usuario
    
    Note over U,DB: Login con Google OAuth2
    U->>F: Clic "Login con Google"
    F->>B: GET /api/users/oauth2/login-url
    B-->>F: URL de Google OAuth
    F->>G: Redirige a Google
    G-->>U: Pantalla de autorización
    U->>G: Autoriza aplicación
    G->>B: Callback con código
    B->>G: Intercambiar código por token
    G-->>B: User info de Google
    B->>DB: Buscar/crear usuario
    DB-->>B: Usuario OAuth2
    B->>JWT: Generar token JWT
    JWT-->>B: Token JWT
    B->>F: Redirige con token
    
    Note over U,DB: Para solicitudes posteriores (ambos tipos):
    U->>F: Solicitud + Token JWT
    F->>B: Request con Authorization header
    B->>JWT: Validar token
    JWT->>SC: Establecer Authentication
    SC->>B: User principal
    B->>B: Verificar permisos (isAdmin/isOwner)
    alt Autorizado
        B->>DB: Ejecutar operación
        DB-->>B: Resultado
        B-->>F: Respuesta exitosa
        F-->>U: Resultado
    else No autorizado
        B-->>F: 403 Forbidden
        F-->>U: Error de permisos
    end 