graph TB
    subgraph "🎨 Frontend - Sistema de Autenticación"
        subgraph "🌐 Opciones de Login"
            LOGIN_LOCAL[📝 Login Local]
            LOGIN_OAUTH[🌐 Login Google OAuth2]
            REGISTER[📝 Registro Simple]
        end
        
        subgraph "🔑 Procesamiento Frontend"
            VALIDATE_FORM[✔️ Validar formulario]
            SEND_CREDENTIALS[📤 Enviar credenciales]
            REDIRECT_GOOGLE[🔄 Redirigir a Google]
            EXTRACT_PARAMS[📋 Extraer parámetros URL]
            STORE_TOKEN[💾 Guardar en localStorage]
            EXTRACT_USER[👤 Extraer datos usuario]
        end
        
        subgraph "🛡️ Protección de Rutas"
            AUTH_GUARD[🛡️ Guard de autenticación]
            ADMIN_GUARD[👑 Guard de admin]
            REDIRECT_LOGIN[🔄 Redirigir a login]
            ACCESS_GRANTED[✅ Acceso concedido]
        end
        
        subgraph "📡 Interceptor HTTP"
            ATTACH_TOKEN[🔗 Adjuntar token]
            HANDLE_401[❌ Manejar 401]
            AUTO_LOGOUT[🚪 Logout automático]
        end
    end
    
    subgraph "🖥️ Backend - Procesamiento de Autenticación"
        subgraph "🔐 Endpoints de Auth"
            API_LOGIN[POST /api/users/login]
            API_OAUTH_URL[GET /api/users/oauth2/login-url]
            API_OAUTH_CALLBACK[OAuth2 Callback]
            API_REGISTER[POST /api/users/simple-register]
        end
        
        subgraph "🔑 Procesamiento Backend"
            VERIFY_CREDENTIALS[🔍 Verificar credenciales]
            GENERATE_JWT[🔑 Generar JWT]
            EXCHANGE_CODE[🔄 Intercambiar código OAuth]
            CREATE_USER[👤 Crear/buscar usuario]
            VALIDATE_JWT[✔️ Validar JWT]
            SET_SECURITY_CONTEXT[🛡️ Establecer SecurityContext]
            CHECK_PERMISSIONS[🔍 Verificar permisos]
        end
    end
    
    subgraph "🌐 Servicios Externos"
        GOOGLE_OAUTH[🌐 Google OAuth2]
        DATABASE[(🗄️ Base de Datos)]
    end
    
    %% Flujo Login Local
    LOGIN_LOCAL --> VALIDATE_FORM
    VALIDATE_FORM --> SEND_CREDENTIALS
    SEND_CREDENTIALS --> API_LOGIN
    API_LOGIN --> VERIFY_CREDENTIALS
    VERIFY_CREDENTIALS --> DATABASE
    DATABASE --> GENERATE_JWT
    GENERATE_JWT --> STORE_TOKEN
    
    %% Flujo OAuth2
    LOGIN_OAUTH --> REDIRECT_GOOGLE
    REDIRECT_GOOGLE --> API_OAUTH_URL
    API_OAUTH_URL --> GOOGLE_OAUTH
    GOOGLE_OAUTH --> API_OAUTH_CALLBACK
    API_OAUTH_CALLBACK --> EXCHANGE_CODE
    EXCHANGE_CODE --> GOOGLE_OAUTH
    GOOGLE_OAUTH --> CREATE_USER
    CREATE_USER --> DATABASE
    DATABASE --> GENERATE_JWT
    GENERATE_JWT --> EXTRACT_PARAMS
    EXTRACT_PARAMS --> STORE_TOKEN
    
    %% Flujo Registro
    REGISTER --> VALIDATE_FORM
    VALIDATE_FORM --> API_REGISTER
    API_REGISTER --> CREATE_USER
    
    %% Gestión de Sesión y Seguridad
    STORE_TOKEN --> EXTRACT_USER
    EXTRACT_USER --> AUTH_GUARD
    AUTH_GUARD --> ADMIN_GUARD
    ADMIN_GUARD --> ACCESS_GRANTED
    ACCESS_GRANTED --> ATTACH_TOKEN
    
    %% Interceptor y Validación
    ATTACH_TOKEN --> VALIDATE_JWT
    VALIDATE_JWT --> SET_SECURITY_CONTEXT
    SET_SECURITY_CONTEXT --> CHECK_PERMISSIONS
    CHECK_PERMISSIONS --> |✅ Autorizado| ACCESS_GRANTED
    CHECK_PERMISSIONS --> |❌ No autorizado| HANDLE_401
    HANDLE_401 --> AUTO_LOGOUT
    AUTO_LOGOUT --> REDIRECT_LOGIN
    
    %% Estilos
    classDef frontend fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef backend fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef external fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    
    class LOGIN_LOCAL,LOGIN_OAUTH,REGISTER,VALIDATE_FORM,SEND_CREDENTIALS,REDIRECT_GOOGLE,EXTRACT_PARAMS,STORE_TOKEN,EXTRACT_USER,AUTH_GUARD,ADMIN_GUARD,REDIRECT_LOGIN,ACCESS_GRANTED,ATTACH_TOKEN,HANDLE_401,AUTO_LOGOUT frontend
    
    class API_LOGIN,API_OAUTH_URL,API_OAUTH_CALLBACK,API_REGISTER,VERIFY_CREDENTIALS,GENERATE_JWT,EXCHANGE_CODE,CREATE_USER,VALIDATE_JWT,SET_SECURITY_CONTEXT,CHECK_PERMISSIONS backend
    
    class GOOGLE_OAUTH,DATABASE external
